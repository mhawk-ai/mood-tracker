<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Mood Tracker</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,700;0,900;1,400;1,700&family=DM+Mono:ital,wght@0,300;0,400;0,500;1,300&family=Lora:ital,wght@0,400;1,400;1,600&display=swap" rel="stylesheet">
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --paper:      #F4EFE4;
      --paper2:     #EDE6D6;
      --paper3:     #E3DAC5;
      --ink:        #1C1612;
      --ink2:       #3D3328;
      --ink3:       #6B5B47;
      --ink4:       #9C8A72;
      --rule:       rgba(100,80,55,.12);
      --terra:      #C4622D;
      --terra-lt:   rgba(196,98,45,.12);
      --serif:      'Playfair Display', Georgia, serif;
      --mono:       'DM Mono', 'Courier New', monospace;
      --lora:       'Lora', Georgia, serif;
    }

    html { font-size: 16px; }

    body {
      background: var(--paper);
      color: var(--ink);
      font-family: var(--lora);
      min-height: 100svh;
      overflow-x: hidden;
      cursor: default;
    }

    /* ‚îÄ‚îÄ GRAIN OVERLAY ‚îÄ‚îÄ */
    body::before {
      content: '';
      position: fixed;
      inset: 0;
      pointer-events: none;
      z-index: 1000;
      opacity: .032;
      background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 512 512' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)'/%3E%3C/svg%3E");
      background-repeat: repeat;
      background-size: 200px 200px;
    }

    /* ‚îÄ‚îÄ RULED LINES ‚îÄ‚îÄ */
    body::after {
      content: '';
      position: fixed;
      inset: 0;
      pointer-events: none;
      z-index: 0;
      background-image: repeating-linear-gradient(
        to bottom,
        transparent,
        transparent 31px,
        var(--rule) 31px,
        var(--rule) 32px
      );
      background-attachment: fixed;
    }

    /* ‚îÄ‚îÄ LAYOUT ‚îÄ‚îÄ */
    .page {
      position: relative;
      z-index: 1;
      max-width: 680px;
      margin: 0 auto;
      padding: 0 1.5rem 5rem;
    }

    /* ‚îÄ‚îÄ MASTHEAD ‚îÄ‚îÄ */
    .masthead {
      border-bottom: 2px solid var(--ink);
      padding: 2.5rem 0 1rem;
      margin-bottom: 2.5rem;
      display: flex;
      align-items: flex-end;
      justify-content: space-between;
      gap: 1rem;
      animation: fadeIn .7s ease both;
    }
    .masthead-left { flex: 1; }
    .masthead-label {
      font-family: var(--mono);
      font-size: .65rem;
      font-weight: 500;
      letter-spacing: .18em;
      text-transform: uppercase;
      color: var(--terra);
      margin-bottom: .5rem;
    }
    .masthead h1 {
      font-family: var(--serif);
      font-size: clamp(2.6rem, 8vw, 4.2rem);
      font-weight: 900;
      line-height: .92;
      letter-spacing: -.02em;
      color: var(--ink);
    }
    .masthead h1 em {
      font-style: italic;
      font-weight: 400;
      color: var(--terra);
    }
    .masthead-right {
      text-align: right;
      flex-shrink: 0;
    }
    .masthead-date {
      font-family: var(--mono);
      font-size: .7rem;
      color: var(--ink3);
      line-height: 1.7;
    }
    .masthead-divider {
      width: 1px;
      height: 3.5rem;
      background: var(--ink4);
      flex-shrink: 0;
    }

    /* ‚îÄ‚îÄ SECTION LABELS ‚îÄ‚îÄ */
    .section-label {
      font-family: var(--mono);
      font-size: .6rem;
      font-weight: 500;
      letter-spacing: .2em;
      text-transform: uppercase;
      color: var(--ink4);
      margin-bottom: 1.2rem;
      display: flex;
      align-items: center;
      gap: .75rem;
    }
    .section-label::after {
      content: '';
      flex: 1;
      height: 1px;
      background: var(--paper3);
    }

    /* ‚îÄ‚îÄ MOOD STAMP GRID ‚îÄ‚îÄ */
    .pick-section {
      margin-bottom: 2.5rem;
      animation: fadeIn .7s .1s ease both;
    }
    .mood-question {
      font-family: var(--serif);
      font-size: 1.35rem;
      font-style: italic;
      color: var(--ink2);
      margin-bottom: 1.6rem;
      line-height: 1.4;
    }
    .mood-grid {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: .7rem;
      margin-bottom: 1.8rem;
    }
    .mood-btn {
      all: unset;
      cursor: pointer;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: .45rem;
      padding: .9rem .3rem .75rem;
      border-radius: 4px;
      border: 1.5px solid var(--paper3);
      background: transparent;
      transition: all .18s cubic-bezier(.25,.46,.45,.94);
      user-select: none;
      -webkit-tap-highlight-color: transparent;
      position: relative;
      overflow: hidden;
    }
    /* ink-blot fill on select */
    .mood-btn::before {
      content: '';
      position: absolute;
      inset: 0;
      border-radius: 3px;
      background: var(--mood-ink, var(--paper3));
      transform: scale(0);
      transform-origin: center;
      transition: transform .22s cubic-bezier(.34,1.56,.64,1);
      opacity: .13;
    }
    .mood-btn:hover {
      border-color: var(--mood-ink, var(--ink3));
      background: color-mix(in srgb, var(--mood-ink, var(--ink)) 6%, transparent);
      transform: translateY(-2px);
    }
    .mood-btn:hover::before { transform: scale(1); }
    .mood-btn:active { transform: scale(.93); }

    .mood-btn .emoji {
      font-size: 1.75rem;
      line-height: 1;
      filter: saturate(.9);
      transition: transform .18s;
    }
    .mood-btn:hover .emoji { transform: scale(1.15) rotate(-4deg); }

    .mood-btn .label {
      font-family: var(--mono);
      font-size: .58rem;
      font-weight: 500;
      letter-spacing: .07em;
      color: var(--ink4);
      text-transform: uppercase;
      transition: color .18s;
    }

    /* selected state */
    .mood-btn.selected {
      border-color: var(--mood-ink, var(--ink)) !important;
      background: color-mix(in srgb, var(--mood-ink, var(--ink)) 10%, var(--paper)) !important;
      transform: scale(1.08) translateY(-2px) !important;
      box-shadow: 3px 3px 0 var(--mood-ink, var(--ink)) !important;
    }
    .mood-btn.selected::before { transform: scale(1); opacity: .2; }
    .mood-btn.selected .emoji { transform: scale(1.1); }
    .mood-btn.selected .label { color: var(--mood-ink, var(--ink)); font-weight: 500; }

    /* ‚îÄ‚îÄ LOG BUTTON ‚îÄ‚îÄ */
    .log-wrap {
      display: flex;
      align-items: center;
      gap: 1.2rem;
    }
    .log-btn {
      all: unset;
      cursor: pointer;
      font-family: var(--serif);
      font-size: 1.05rem;
      font-weight: 700;
      font-style: italic;
      color: var(--paper);
      background: var(--ink);
      padding: .85rem 2.5rem;
      border-radius: 2px;
      letter-spacing: .02em;
      position: relative;
      overflow: hidden;
      transition: transform .15s, box-shadow .15s;
      box-shadow: 4px 4px 0 var(--ink4);
    }
    .log-btn::after {
      content: '';
      position: absolute;
      inset: 0;
      background: var(--terra);
      transform: translateX(-101%);
      transition: transform .28s cubic-bezier(.65,0,.35,1);
    }
    .log-btn span { position: relative; z-index: 1; }
    .log-btn:not(:disabled):hover {
      transform: translate(-2px,-2px);
      box-shadow: 6px 6px 0 var(--ink);
    }
    .log-btn:not(:disabled):hover::after { transform: translateX(0); }
    .log-btn:not(:disabled):active { transform: translate(2px,2px); box-shadow: 2px 2px 0 var(--ink4); }
    .log-btn:disabled {
      opacity: .35;
      cursor: default;
      box-shadow: 2px 2px 0 var(--ink4);
    }
    .log-hint {
      font-family: var(--mono);
      font-size: .65rem;
      color: var(--ink4);
      font-style: italic;
    }
    .log-btn.flash { animation: stampPress .35s ease; }
    @keyframes stampPress {
      0%   { transform: scale(1); }
      30%  { transform: translate(2px,2px) scale(.95); box-shadow: 2px 2px 0 var(--ink4); }
      60%  { transform: translate(-2px,-2px) scale(1.04); }
      100% { transform: scale(1); }
    }

    /* ‚îÄ‚îÄ DIVIDER ‚îÄ‚îÄ */
    .ink-rule {
      border: none;
      border-top: 1px solid var(--paper3);
      margin: 2rem 0;
    }
    .ink-rule.heavy {
      border-top: 2px solid var(--ink);
      margin: 2.5rem 0;
    }

    /* ‚îÄ‚îÄ CHART SECTION ‚îÄ‚îÄ */
    .chart-section {
      margin-bottom: 2.5rem;
      animation: fadeIn .7s .2s ease both;
    }
    .chart-controls-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 1.2rem;
    }
    .view-toggle {
      display: flex;
      gap: 0;
      border: 1.5px solid var(--paper3);
      border-radius: 2px;
      overflow: hidden;
    }
    .view-btn {
      all: unset;
      cursor: pointer;
      font-family: var(--mono);
      font-size: .6rem;
      font-weight: 500;
      letter-spacing: .1em;
      text-transform: uppercase;
      padding: .35rem .85rem;
      color: var(--ink4);
      background: transparent;
      transition: color .15s, background .15s;
      border-right: 1.5px solid var(--paper3);
    }
    .view-btn:last-child { border-right: none; }
    .view-btn.active {
      color: var(--paper);
      background: var(--ink);
    }

    /* graph paper canvas wrap */
    .canvas-wrap {
      position: relative;
      width: 100%;
      height: 190px;
      background:
        linear-gradient(var(--rule) 1px, transparent 1px),
        linear-gradient(90deg, var(--rule) 1px, transparent 1px);
      background-size: 32px 32px;
      background-color: color-mix(in srgb, var(--paper2) 60%, var(--paper));
      border: 1.5px solid var(--paper3);
      border-radius: 2px;
      overflow: hidden;
    }

    canvas {
      display: block;
      width: 100%;
      height: 100%;
    }
    .empty-state {
      position: absolute;
      inset: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: .5rem;
      color: var(--ink4);
    }
    .empty-state .empty-icon {
      font-family: var(--serif);
      font-size: 2rem;
      font-style: italic;
      opacity: .4;
    }
    .empty-state p {
      font-family: var(--mono);
      font-size: .65rem;
      letter-spacing: .1em;
      text-transform: uppercase;
    }

    /* ‚îÄ‚îÄ STATS LEDGER ‚îÄ‚îÄ */
    .stats-row {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      margin-top: 1.2rem;
      border: 1.5px solid var(--ink);
      border-radius: 2px;
      overflow: hidden;
    }
    .stat-box {
      padding: 1rem .75rem;
      text-align: center;
      border-right: 1.5px solid var(--ink);
      background: transparent;
      position: relative;
    }
    .stat-box:last-child { border-right: none; }
    .stat-box::before {
      content: '';
      position: absolute;
      top: 0; left: 0; right: 0;
      height: 3px;
      background: var(--terra);
      transform: scaleX(0);
      transform-origin: left;
      transition: transform .4s ease;
    }
    .stat-box.loaded::before { transform: scaleX(1); }
    .stat-box .val {
      font-family: var(--serif);
      font-size: 2rem;
      font-weight: 900;
      line-height: 1;
      margin-bottom: .3rem;
      color: var(--ink);
    }
    .stat-box .key {
      font-family: var(--mono);
      font-size: .55rem;
      color: var(--ink4);
      text-transform: uppercase;
      letter-spacing: .12em;
    }

    /* ‚îÄ‚îÄ RECENT ENTRIES ‚îÄ‚îÄ */
    .recent-section {
      animation: fadeIn .7s .3s ease both;
    }
    .recent-header-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 1rem;
    }
    .clear-btn {
      all: unset;
      cursor: pointer;
      font-family: var(--mono);
      font-size: .6rem;
      letter-spacing: .1em;
      text-transform: uppercase;
      color: var(--ink4);
      padding: .3rem .7rem;
      border: 1px solid var(--paper3);
      border-radius: 2px;
      transition: color .15s, border-color .15s, background .15s;
    }
    .clear-btn:hover {
      color: var(--terra);
      border-color: var(--terra);
      background: var(--terra-lt);
    }

    .log-list {
      display: flex;
      flex-direction: column;
      max-height: 280px;
      overflow-y: auto;
      scrollbar-width: thin;
      scrollbar-color: var(--paper3) transparent;
      border: 1.5px solid var(--paper3);
      border-radius: 2px;
      overflow: hidden;
      overflow-y: auto;
    }
    .log-item {
      display: grid;
      grid-template-columns: auto 1fr auto auto;
      align-items: center;
      gap: .75rem;
      padding: .65rem 1rem;
      border-bottom: 1px solid var(--paper3);
      animation: slideRight .25s ease;
      background: transparent;
      transition: background .15s;
    }
    .log-item:last-child { border-bottom: none; }
    .log-item:hover { background: var(--paper2); }

    .log-item .item-num {
      font-family: var(--mono);
      font-size: .6rem;
      color: var(--ink4);
      width: 1.5rem;
      text-align: right;
    }
    .log-item .item-emoji { font-size: 1.1rem; }
    .log-item .item-name {
      font-family: var(--lora);
      font-size: .88rem;
      font-style: italic;
      color: var(--ink2);
    }
    .log-item .item-mood-dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: var(--mood-dot-color, var(--ink4));
      flex-shrink: 0;
    }
    .log-item .item-time {
      font-family: var(--mono);
      font-size: .6rem;
      color: var(--ink4);
      text-align: right;
    }

    /* ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ */
    .toast {
      position: fixed;
      bottom: 2rem;
      left: 50%;
      transform: translateX(-50%) translateY(3rem);
      background: var(--ink);
      color: var(--paper);
      padding: .6rem 1.4rem;
      border-radius: 2px;
      font-family: var(--mono);
      font-size: .72rem;
      letter-spacing: .06em;
      font-weight: 500;
      box-shadow: 4px 4px 0 var(--ink3);
      pointer-events: none;
      opacity: 0;
      transition: transform .35s cubic-bezier(.34,1.56,.64,1), opacity .3s;
      z-index: 999;
      white-space: nowrap;
    }
    .toast.show {
      opacity: 1;
      transform: translateX(-50%) translateY(0);
    }

    /* ‚îÄ‚îÄ PARTICLE BURST ‚îÄ‚îÄ */
    .burst { position: fixed; pointer-events: none; z-index: 9999; }
    .burst-dot {
      position: absolute;
      width: 7px; height: 7px;
      border-radius: 50%;
      will-change: transform, opacity;
    }

    /* ‚îÄ‚îÄ ANIMATIONS ‚îÄ‚îÄ */
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to   { opacity: 1; transform: translateY(0); }
    }
    @keyframes slideRight {
      from { opacity: 0; transform: translateX(-10px); }
      to   { opacity: 1; transform: translateX(0); }
    }

    /* ‚îÄ‚îÄ RESPONSIVE ‚îÄ‚îÄ */
    @media (max-width: 480px) {
      .masthead { flex-direction: column; align-items: flex-start; }
      .masthead-divider { display: none; }
      .masthead-right { text-align: left; }
      .mood-grid { grid-template-columns: repeat(5, 1fr); gap: .45rem; }
      .mood-btn { padding: .65rem .2rem .55rem; }
      .mood-btn .emoji { font-size: 1.4rem; }
    }
  </style>
</head>
<body>
<div class="page">

  <!-- MASTHEAD -->
  <header class="masthead">
    <div class="masthead-left">
      <div class="masthead-label">Personal Field Notes</div>
      <h1>Mood<br><em>Tracker</em></h1>
    </div>
    <div class="masthead-divider"></div>
    <div class="masthead-right">
      <div class="masthead-date" id="mastheadDate"></div>
    </div>
  </header>

  <!-- MOOD PICKER -->
  <section class="pick-section">
    <div class="section-label">Today's entry</div>
    <p class="mood-question">How are you feeling right now?</p>
    <div class="mood-grid" id="moodGrid"></div>
    <div class="log-wrap">
      <button class="log-btn" id="logBtn" disabled><span>Record entry</span></button>
      <span class="log-hint" id="logHint">select a mood above</span>
    </div>
  </section>

  <hr class="ink-rule heavy">

  <!-- CHART -->
  <section class="chart-section" id="chartCard">
    <div class="chart-controls-row">
      <div class="section-label" style="margin-bottom:0;flex:1">14-day history</div>
      <div class="view-toggle">
        <button class="view-btn active" id="btnBar">Bar</button>
        <button class="view-btn" id="btnLine">Line</button>
      </div>
    </div>

    <div class="canvas-wrap" id="canvasWrap">
      <div class="empty-state" id="emptyState">
        <span class="empty-icon">&#8203;</span>
        <p>No entries yet</p>
      </div>
      <canvas id="chart" style="display:none"></canvas>
    </div>

    <div class="stats-row" id="statsRow" style="display:none">
      <div class="stat-box" id="statBoxStreak">
        <div class="val" id="statStreak">0</div>
        <div class="key">Day streak</div>
      </div>
      <div class="stat-box" id="statBoxTotal">
        <div class="val" id="statTotal">0</div>
        <div class="key">Total logs</div>
      </div>
      <div class="stat-box" id="statBoxTop">
        <div class="val" id="statTop">&#8212;</div>
        <div class="key">Top mood</div>
      </div>
    </div>
  </section>

  <!-- RECENT ENTRIES -->
  <section class="recent-section" id="recentCard" style="display:none">
    <hr class="ink-rule">
    <div class="recent-header-row">
      <div class="section-label" style="margin-bottom:0;flex:1">Recent entries</div>
      <button class="clear-btn" id="clearBtn">Clear all</button>
    </div>
    <div class="log-list" id="logList"></div>
  </section>

</div><!-- /page -->

<div class="toast" id="toast"></div>

<script>
/* ===== DATA ===== */
const MOODS = [
  { emoji: 'üòÅ', label: 'Great',   score: 5, color: '#3D9A5C', ink: '#3D9A5C' },
  { emoji: 'üôÇ', label: 'Good',    score: 4, color: '#2A8A7E', ink: '#2A8A7E' },
  { emoji: 'üòê', label: 'Okay',    score: 3, color: '#B8860B', ink: '#B8860B' },
  { emoji: 'üòï', label: 'Low',     score: 2, color: '#C4622D', ink: '#C4622D' },
  { emoji: 'üò¢', label: 'Sad',     score: 1, color: '#3B6EA5', ink: '#3B6EA5' },
  { emoji: 'üò°', label: 'Angry',   score: 1, color: '#A82C2C', ink: '#A82C2C' },
  { emoji: 'üò∞', label: 'Anxious', score: 2, color: '#7A4F9A', ink: '#7A4F9A' },
  { emoji: 'üò¥', label: 'Tired',   score: 2, color: '#5A6B7A', ink: '#5A6B7A' },
  { emoji: 'ü§©', label: 'Excited', score: 5, color: '#B5476A', ink: '#B5476A' },
  { emoji: 'üòå', label: 'Calm',    score: 4, color: '#2878A0', ink: '#2878A0' },
];

const STORAGE_KEY = 'mood_tracker_log';
function loadLog() { try { return JSON.parse(localStorage.getItem(STORAGE_KEY)) || []; } catch { return []; } }
function saveLog(log) { localStorage.setItem(STORAGE_KEY, JSON.stringify(log)); }

/* ===== STATE ===== */
let log = loadLog();
let selectedMood = null;
let chartMode = 'bar';
let animFrame = null;

/* ===== DATE HEADER ===== */
const now = new Date();
document.getElementById('mastheadDate').innerHTML =
  `${now.toLocaleDateString('en-US', {weekday:'long'})}<br>${now.toLocaleDateString('en-US',{month:'long',day:'numeric',year:'numeric'})}`;

/* ===== BUILD MOOD GRID ===== */
const grid = document.getElementById('moodGrid');
MOODS.forEach((m, i) => {
  const btn = document.createElement('button');
  btn.className = 'mood-btn';
  btn.dataset.idx = i;
  btn.style.setProperty('--mood-ink', m.ink);
  btn.innerHTML = `<span class="emoji">${m.emoji}</span><span class="label">${m.label}</span>`;
  btn.addEventListener('click', () => selectMood(i, btn));
  grid.appendChild(btn);
});

function selectMood(idx, btn) {
  document.querySelectorAll('.mood-btn').forEach(b => b.classList.remove('selected'));
  btn.classList.add('selected');
  selectedMood = idx;
  const lb = document.getElementById('logBtn');
  lb.disabled = false;
  document.getElementById('logHint').textContent = MOODS[idx].label.toLowerCase() + ' ‚Äî ready to log';
}

/* ===== LOG BUTTON ===== */
document.getElementById('logBtn').addEventListener('click', () => {
  if (selectedMood === null) return;
  const m = MOODS[selectedMood];
  log.unshift({ mood: selectedMood, ts: Date.now() });
  saveLog(log);

  document.querySelectorAll('.mood-btn').forEach(b => b.classList.remove('selected'));
  selectedMood = null;
  const lb = document.getElementById('logBtn');
  lb.disabled = true;
  document.getElementById('logHint').textContent = 'select a mood above';

  lb.classList.remove('flash');
  void lb.offsetWidth;
  lb.classList.add('flash');

  showToast(`${m.emoji}  ${m.label} recorded`);
  spawnBurst(m.color);
  render();
});

/* ===== CHART TOGGLE ===== */
document.getElementById('btnBar').addEventListener('click', () => {
  chartMode = 'bar';
  document.getElementById('btnBar').classList.add('active');
  document.getElementById('btnLine').classList.remove('active');
  drawChart();
});
document.getElementById('btnLine').addEventListener('click', () => {
  chartMode = 'line';
  document.getElementById('btnLine').classList.add('active');
  document.getElementById('btnBar').classList.remove('active');
  drawChart();
});

/* ===== CLEAR ===== */
document.getElementById('clearBtn').addEventListener('click', () => {
  if (!confirm('Clear all mood history?')) return;
  log = []; saveLog(log); render();
});

/* ===== RENDER ===== */
function render() { renderStats(); renderList(); drawChart(); }

function renderStats() {
  const statsRow = document.getElementById('statsRow');
  if (log.length === 0) { statsRow.style.display = 'none'; return; }
  statsRow.style.display = 'grid';

  const days = new Set(log.map(e => new Date(e.ts).toDateString()));
  let streak = 0, d = new Date();
  while (days.has(d.toDateString())) { streak++; d.setDate(d.getDate() - 1); }

  document.getElementById('statStreak').textContent = streak;
  document.getElementById('statTotal').textContent = log.length;

  const counts = {};
  log.forEach(e => { counts[e.mood] = (counts[e.mood] || 0) + 1; });
  const top = Object.entries(counts).sort((a, b) => b[1] - a[1])[0];
  document.getElementById('statTop').textContent = top ? MOODS[top[0]].emoji : '‚Äî';

  // trigger the top-bar accent animation
  setTimeout(() => {
    ['statBoxStreak','statBoxTotal','statBoxTop'].forEach(id => {
      const el = document.getElementById(id);
      el.classList.remove('loaded');
      void el.offsetWidth;
      el.classList.add('loaded');
    });
  }, 50);
}

function renderList() {
  const recentCard = document.getElementById('recentCard');
  const list = document.getElementById('logList');
  if (log.length === 0) { recentCard.style.display = 'none'; return; }
  recentCard.style.display = 'block';
  list.innerHTML = '';
  log.slice(0, 20).forEach((entry, i) => {
    const m = MOODS[entry.mood];
    const dt = new Date(entry.ts);
    const timeStr = dt.toLocaleString([], { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
    const item = document.createElement('div');
    item.className = 'log-item';
    item.innerHTML = `
      <span class="item-num">${String(i+1).padStart(2,'0')}</span>
      <span class="item-emoji">${m.emoji}</span>
      <span class="item-name">${m.label}</span>
      <span class="item-mood-dot" style="--mood-dot-color:${m.color}"></span>
      <span class="item-time">${timeStr}</span>`;
    list.appendChild(item);
  });
}

/* ===== CHART ===== */
function drawChart() {
  const emptyState = document.getElementById('emptyState');
  const canvas = document.getElementById('chart');
  if (log.length === 0) {
    emptyState.style.display = 'flex'; canvas.style.display = 'none'; return;
  }
  emptyState.style.display = 'none'; canvas.style.display = 'block';
  const buckets = buildBuckets(14);
  cancelAnimationFrame(animFrame);
  if (chartMode === 'bar') animateBar(canvas, buckets);
  else animateLine(canvas, buckets);
}

function buildBuckets(n) {
  const buckets = [];
  for (let i = n - 1; i >= 0; i--) {
    const d = new Date(); d.setHours(0,0,0,0); d.setDate(d.getDate() - i);
    const label = d.toLocaleDateString([], { month: 'short', day: 'numeric' });
    const dayStr = d.toDateString();
    const entries = log.filter(e => new Date(e.ts).toDateString() === dayStr);
    const avg = entries.length ? entries.reduce((s, e) => s + MOODS[e.mood].score, 0) / entries.length : null;
    buckets.push({ label, avg, count: entries.length });
  }
  return buckets;
}

function scoreColor(score) {
  if (score >= 4.5) return '#3D9A5C';
  if (score >= 3.5) return '#6A9A3A';
  if (score >= 2.5) return '#B8860B';
  if (score >= 1.5) return '#C4622D';
  return '#A82C2C';
}

function setupCanvas(canvas) {
  const wrap = canvas.parentElement;
  const dpr = window.devicePixelRatio || 1;
  const w = wrap.clientWidth; const h = wrap.clientHeight;
  canvas.width = w * dpr; canvas.height = h * dpr;
  const ctx = canvas.getContext('2d'); ctx.scale(dpr, dpr);
  return { ctx, w, h };
}

function animateBar(canvas, buckets) {
  const { ctx, w, h } = setupCanvas(canvas);
  const PAD = { top: 14, right: 12, bottom: 30, left: 12 };
  const cW = w - PAD.left - PAD.right;
  const cH = h - PAD.top - PAD.bottom;
  const n = buckets.length;
  const gap = 4;
  const barW = (cW - gap * (n - 1)) / n;
  let progress = 0; let start = null;

  function frame(ts) {
    if (!start) start = ts;
    progress = Math.min((ts - start) / 550, 1);
    const ease = 1 - Math.pow(1 - progress, 3);
    ctx.clearRect(0, 0, w, h);

    buckets.forEach((b, i) => {
      const x = PAD.left + i * (barW + gap);
      if (b.avg !== null) {
        const bH = (b.avg / 5) * cH * ease;
        const y = PAD.top + cH - bH;
        const c = scoreColor(b.avg);
        ctx.fillStyle = c;
        roundRect(ctx, x, y, barW, bH, Math.min(3, barW / 3));
        ctx.fill();
        // top tick
        ctx.fillStyle = c;
        roundRect(ctx, x, y - 2, barW, 3, 1);
        ctx.fill();
      } else {
        ctx.fillStyle = 'rgba(100,80,55,.08)';
        roundRect(ctx, x, PAD.top + cH - 3, barW, 3, 1);
        ctx.fill();
      }
      // label
      if (i % 3 === 0 || n <= 7) {
        ctx.fillStyle = 'rgba(100,80,55,.4)';
        ctx.font = `500 8px 'DM Mono', monospace`;
        ctx.textAlign = 'center';
        ctx.fillText(b.label, x + barW / 2, h - 8);
      }
    });
    if (progress < 1) animFrame = requestAnimationFrame(frame);
  }
  animFrame = requestAnimationFrame(frame);
}

function animateLine(canvas, buckets) {
  const { ctx, w, h } = setupCanvas(canvas);
  const PAD = { top: 14, right: 16, bottom: 30, left: 16 };
  const cW = w - PAD.left - PAD.right;
  const cH = h - PAD.top - PAD.bottom;
  const validPts = buckets
    .map((b, i) => b.avg !== null ? { x: PAD.left + (i/(buckets.length-1))*cW, y: PAD.top + cH - (b.avg/5)*cH, b } : null)
    .filter(Boolean);
  if (validPts.length === 0) return;
  let progress = 0; let start = null;

  function frame(ts) {
    if (!start) start = ts;
    progress = Math.min((ts - start) / 650, 1);
    ctx.clearRect(0, 0, w, h);

    ctx.save();
    ctx.rect(PAD.left, 0, cW * progress, h);
    ctx.clip();

    // area
    const grd = ctx.createLinearGradient(0, PAD.top, 0, PAD.top + cH);
    grd.addColorStop(0, 'rgba(196,98,45,.25)');
    grd.addColorStop(1, 'rgba(196,98,45,.02)');
    ctx.beginPath();
    ctx.moveTo(validPts[0].x, PAD.top + cH);
    ctx.lineTo(validPts[0].x, validPts[0].y);
    for (let i = 1; i < validPts.length; i++) {
      const cp = (validPts[i].x + validPts[i-1].x) / 2;
      ctx.bezierCurveTo(cp, validPts[i-1].y, cp, validPts[i].y, validPts[i].x, validPts[i].y);
    }
    ctx.lineTo(validPts[validPts.length-1].x, PAD.top + cH);
    ctx.closePath();
    ctx.fillStyle = grd;
    ctx.fill();

    // line
    ctx.beginPath();
    ctx.moveTo(validPts[0].x, validPts[0].y);
    for (let i = 1; i < validPts.length; i++) {
      const cp = (validPts[i].x + validPts[i-1].x) / 2;
      ctx.bezierCurveTo(cp, validPts[i-1].y, cp, validPts[i].y, validPts[i].x, validPts[i].y);
    }
    ctx.strokeStyle = '#C4622D';
    ctx.lineWidth = 2;
    ctx.lineJoin = 'round';
    ctx.stroke();

    // dots
    validPts.forEach(p => {
      ctx.beginPath(); ctx.arc(p.x, p.y, 4, 0, Math.PI*2);
      ctx.fillStyle = scoreColor(p.b.avg);
      ctx.fill();
      ctx.strokeStyle = getComputedStyle(document.body).getPropertyValue('--paper').trim() || '#F4EFE4';
      ctx.lineWidth = 1.5; ctx.stroke();
    });

    ctx.restore();

    // x labels
    buckets.forEach((b, i) => {
      if (i % 3 === 0 || buckets.length <= 7) {
        const x = PAD.left + (i/(buckets.length-1))*cW;
        ctx.fillStyle = 'rgba(100,80,55,.4)';
        ctx.font = `500 8px 'DM Mono', monospace`;
        ctx.textAlign = 'center';
        ctx.fillText(b.label, x, h - 8);
      }
    });

    if (progress < 1) animFrame = requestAnimationFrame(frame);
  }
  animFrame = requestAnimationFrame(frame);
}

function roundRect(ctx, x, y, w, h, r) {
  ctx.beginPath();
  ctx.moveTo(x+r, y); ctx.lineTo(x+w-r, y);
  ctx.quadraticCurveTo(x+w, y, x+w, y+r);
  ctx.lineTo(x+w, y+h-r);
  ctx.quadraticCurveTo(x+w, y+h, x+w-r, y+h);
  ctx.lineTo(x+r, y+h);
  ctx.quadraticCurveTo(x, y+h, x, y+h-r);
  ctx.lineTo(x, y+r);
  ctx.quadraticCurveTo(x, y, x+r, y);
  ctx.closePath();
}

/* ===== TOAST ===== */
let toastTimer = null;
function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  clearTimeout(toastTimer);
  toastTimer = setTimeout(() => t.classList.remove('show'), 2200);
}

/* ===== PARTICLE BURST ===== */
function spawnBurst(color) {
  const logBtn = document.getElementById('logBtn');
  const rect = logBtn.getBoundingClientRect();
  const cx = rect.left + rect.width / 2;
  const cy = rect.top + rect.height / 2;
  const container = document.createElement('div');
  container.className = 'burst';
  container.style.cssText = `left:${cx}px;top:${cy}px;`;
  document.body.appendChild(container);
  const count = 12;
  const dots = [];
  for (let i = 0; i < count; i++) {
    const dot = document.createElement('div');
    dot.className = 'burst-dot';
    const angle = (i / count) * Math.PI * 2;
    const dist = 35 + Math.random() * 45;
    dot.style.background = color;
    container.appendChild(dot);
    dots.push({ dot, vx: Math.cos(angle)*dist, vy: Math.sin(angle)*dist });
  }
  let start = null; const dur = 550;
  function anim(ts) {
    if (!start) start = ts;
    const p = Math.min((ts - start) / dur, 1);
    dots.forEach(({ dot, vx, vy }) => {
      dot.style.transform = `translate(${vx*p}px,${vy*p}px)`;
      dot.style.opacity = 1 - p*p;
    });
    if (p < 1) requestAnimationFrame(anim); else container.remove();
  }
  requestAnimationFrame(anim);
}

window.addEventListener('resize', () => { if (log.length > 0) drawChart(); });

render();
</script>
</body>
</html>
